<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Nullpo web</title>
</head>
<body>
    <div id="header">
        <h1>Nullpo web</h1>
    </div>
    <div id="info">ログインしていません</div>
    <a id="login" href="https://discord.com/api/oauth2/authorize?client_id=978923316557537280&redirect_uri=http%3A%2F%2Flocalhost%3A3000&response_type=code&scope=identify"> Discordでログイン </a>
    <script>    
function generateRandomString() {
    let randomString = '';
    const randomNumber = Math.floor(Math.random() * 10);
    for (let i = 0; i < 20 + randomNumber; i++) {
        randomString += String.fromCharCode(33 + Math.floor(Math.random() * 94));
    }

    return randomString;
}



window.onload = async () => {
    const fragment = new URLSearchParams(window.location.hash.slice(1));
    const [accessToken, tokenType] = [fragment.get("access_token"), fragment.get("token_type"), fragment.get('state')];

    if(!accessToken) {
        const randomString = generateRandomString();
        localStorage.setItem('oauth-state', randomString);
        document.getElementById('login').href += `&state=${btoa(randomString)}`;
        return (document.getElementById("login").style.display = "none");
    }

    if (localStorage.getItem('oauth-state') !== atob(decodeURIComponent(state))) {
        return console.log('[discordLogin] discordログインURL部にてクリックジャッキングが検出されました。コードを確認してください。');
    }
fetch('https://discord.com/api/users/@me', {
    headers: {
        authorization: `${tokenType} ${accessToken}`,
    },
})
.then(result => result.json())
.then(response => {
    const { username, discriminator, avatar } = response;
    document.getElementById('info').innerHTML = `${username}#${discriminator}さんとしてログイン中`;
    document.getElementById('login').style.display = 'block';
})
.catch(() => {
    document.getElementById('info').innerHTML = 'ログインに失敗しました';
    document.getElementById('login').style.display = 'none';
});
};
    </script>
</body>
</html>